global
    daemon
    maxconn 4096
    log stdout local0 info

    # Lua script for S3 API key extraction (but no rate limiting)
    lua-load /usr/local/etc/haproxy/extract_api_keys.lua

    # Stats socket for runtime API (Docker-friendly path)
    stats socket /tmp/haproxy.sock mode 666 level admin
    stats timeout 30s

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    log global

# Frontend for S3 API requests WITHOUT rate limiting
frontend s3_frontend_no_rate_limiting
    bind *:8080

    # Extract API key (for testing authentication parsing overhead)
    http-request lua.extract_api_key

    # Set group for consistency but no rate limiting
    http-request set-var(txn.rate_group) var(txn.api_key),map(/usr/local/etc/haproxy/config/api_key_groups.map,unknown)

    # Response headers for comparison (but no rate limiting)
    http-response set-header X-RateLimit-Group "%[var(txn.rate_group)]"
    http-response set-header X-API-Key "%[var(txn.api_key)]"
    http-response set-header X-Auth-Method "%[var(txn.auth_method)]"
    http-response set-header X-Test-Mode "NO_RATE_LIMITING"

    default_backend minio_backend

# Backend for MinIO cluster (same as main config)
backend minio_backend
    balance roundrobin
    server minio1 minio:9000

# Stats interface for monitoring
listen stats_no_rl
    bind *:8406
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-desc "HAProxy MinIO NO Rate Limiting - Performance Comparison"