global
    daemon
    maxconn 4096
    log stdout local0 info
    
    # Stats socket for runtime API (Docker-friendly path)
    stats socket /tmp/haproxy.sock mode 666 level admin
    stats timeout 30s

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    log global

# Frontend for S3 API requests with group-based rate limiting
frontend s3_frontend
    bind *:80
    
    # Extract API key from URL parameter (simplified for testing)
    http-request set-var(txn.api_key) url_param(AWSAccessKeyId) if { url_param(AWSAccessKeyId) -m found }
    http-request set-var(txn.api_key) str(unknown) if !{ var(txn.api_key) -m found }
    
    # Set rate limit groups based on specific API keys
    http-request set-var(txn.rate_group) str(premium) if { var(txn.api_key) -m str test-premium-key }
    http-request set-var(txn.rate_group) str(premium) if { var(txn.api_key) -m str minioadmin }
    http-request set-var(txn.rate_group) str(premium) if { var(txn.api_key) -m str AKIAIOSFODNN7EXAMPLE }
    
    http-request set-var(txn.rate_group) str(standard) if { var(txn.api_key) -m str test-standard-key }
    http-request set-var(txn.rate_group) str(standard) if { var(txn.api_key) -m str AKIAQ3EGUO4M7EXAMPLE }
    
    http-request set-var(txn.rate_group) str(basic) if { var(txn.api_key) -m str test-basic-key }
    
    # Default to basic for known patterns, unknown for others
    http-request set-var(txn.rate_group) str(basic) if !{ var(txn.rate_group) -m found } { var(txn.api_key) -m beg test- }
    http-request set-var(txn.rate_group) str(unknown) if !{ var(txn.rate_group) -m found }
    
    # Track requests per API key
    http-request track-sc0 var(txn.api_key) table api_key_rates_1m
    http-request track-sc1 var(txn.api_key) table api_key_rates_1s
    
    # Define method filters (focus on PUT and GET as requested)
    acl rate_limited_methods method PUT GET
    
    # Rate limiting groups
    acl is_premium_group var(txn.rate_group) -m str premium
    acl is_standard_group var(txn.rate_group) -m str standard
    acl is_basic_group var(txn.rate_group) -m str basic
    acl is_unknown_group var(txn.rate_group) -m str unknown
    
    # Rate limit checks per group
    acl premium_rate_exceeded sc_http_req_rate(0) gt 1000
    acl standard_rate_exceeded sc_http_req_rate(0) gt 500
    acl basic_rate_exceeded sc_http_req_rate(0) gt 100
    acl unknown_rate_exceeded sc_http_req_rate(0) gt 50
    
    # Burst rate limit checks
    acl premium_burst_exceeded sc_http_req_rate(1) gt 50
    acl standard_burst_exceeded sc_http_req_rate(1) gt 25
    acl basic_burst_exceeded sc_http_req_rate(1) gt 10
    acl unknown_burst_exceeded sc_http_req_rate(1) gt 5
    
    # Block requests based on group-specific rate limits
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Premium rate limit exceeded (1000/min)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_premium_group premium_rate_exceeded
    
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Standard rate limit exceeded (500/min)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_standard_group standard_rate_exceeded
    
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Basic rate limit exceeded (100/min)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_basic_group basic_rate_exceeded
    
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Rate limit exceeded (50/min)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_unknown_group unknown_rate_exceeded
    
    # Burst limit denials
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Premium burst limit exceeded (50/sec)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_premium_group premium_burst_exceeded
    
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Standard burst limit exceeded (25/sec)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_standard_group standard_burst_exceeded
    
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Basic burst limit exceeded (10/sec)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_basic_group basic_burst_exceeded
    
    http-request deny deny_status 429 content-type "application/xml" string "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Error><Code>SlowDown</Code><Message>Burst limit exceeded (5/sec)</Message><RequestId>%[uuid()]</RequestId></Error>" if rate_limited_methods is_unknown_group unknown_burst_exceeded
    
    # Add comprehensive headers
    http-request set-header X-API-Key-Group %[var(txn.rate_group)]
    http-request set-header X-Request-ID %[uuid()]
    
    # Add group-specific rate limit headers
    http-response set-header X-RateLimit-Group "%[var(txn.rate_group)]"
    http-response set-header X-API-Key "%[var(txn.api_key)]"
    
    # Dynamic rate limit headers based on group
    http-response set-header X-RateLimit-Limit-Per-Minute "1000" if is_premium_group
    http-response set-header X-RateLimit-Limit-Per-Minute "500" if is_standard_group
    http-response set-header X-RateLimit-Limit-Per-Minute "100" if is_basic_group
    http-response set-header X-RateLimit-Limit-Per-Minute "50" if is_unknown_group
    
    http-response set-header X-RateLimit-Limit-Per-Second "50" if is_premium_group
    http-response set-header X-RateLimit-Limit-Per-Second "25" if is_standard_group
    http-response set-header X-RateLimit-Limit-Per-Second "10" if is_basic_group
    http-response set-header X-RateLimit-Limit-Per-Second "5" if is_unknown_group
    
    http-response set-header X-RateLimit-Current-Per-Minute "%[sc_http_req_rate(0)]"
    http-response set-header X-RateLimit-Reset "%[date(),add(3600)]"
    
    default_backend minio_backend

# Backend for MinIO cluster
backend minio_backend
    balance roundrobin
    
    # MinIO server instances (Docker service name)
    server minio1 minio:9000

# Stick tables for API key rate tracking
backend api_key_rates_1m
    stick-table type string len 64 size 100k expire 2m store http_req_rate(1m),http_req_cnt,http_err_rate(1m)

backend api_key_rates_1s
    stick-table type string len 64 size 100k expire 10s store http_req_rate(1s),http_req_cnt

# Stats interface
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-desc "HAProxy MinIO Group-Based Rate Limiting"
